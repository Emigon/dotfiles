#!/bin/sh
[ -z "$1" ] && echo "Give either a pdf file or a DOI as an argument." && exit

if [ -f "$1" ]; then
    # Try to get DOI from pdfinfo or pdftotext output.
    doi=$(pdfinfo "$1" 2>/dev/null | grep -io "doi:.*" | sed "s/ //g")
    if [ -z "$doi" ]; then
        doi=$(pdftotext "$1" 2>/dev/null - |
              grep -ioP "doi(?:\: *|\.org\/)\d+\.\d+\/\w*\.?\w*\d*" -m 1 |
              sed "s/ //g" |
              sed 's/\.org\//:/g')
    fi

    # Check crossref.org for the bib citation.
    if [ -n "$doi" ]; then
        URL="http://api.crossref.org/works/$doi/transform/application/x-bibtex"
        curl -s $URL -w "\\n"
    else
        >&2 echo "Failed to find DOI for $1"
        exit 1
    fi
fi
